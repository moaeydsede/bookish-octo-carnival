rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function userDoc() { return get(/databases/$(database)/documents/users/$(request.auth.uid)); }
    function role() {
      return signedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? userDoc().data.role
        : null;
    }
    function isAdmin() { return role() == "admin"; }
    function isSales() { return role() == "sales"; }
    function isWarehouse() { return role() == "warehouse"; }

    match /users/{uid} {
      allow read: if signedIn() && (isAdmin() || request.auth.uid == uid);
      allow write: if isAdmin();
    }

    match /customers/{id} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    match /products/{id} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // inventory:
    // - admin: write
    // - warehouse: يسمح فقط بتخفيض onHandQty (لا رفع) وبشرط عدم السالب
    match /inventory/{id} {
      allow read: if signedIn();

      allow create, update, delete: if isAdmin();

      allow update: if isWarehouse()
        && request.resource.data.keys().hasOnly(['productCode','onHandQty','updatedAt'])
        && request.resource.data.onHandQty is number
        && resource.data.onHandQty is number
        && request.resource.data.onHandQty <= resource.data.onHandQty
        && request.resource.data.onHandQty >= 0;
    }

    // orders:
    // - admin: كل شيء
    // - sales: create/update لطلباته إذا غير مقفل
    // - warehouse: يسمح بتحديث deliveredTotals/status/isLocked/updatedAt فقط
    match /customer_orders/{id} {
      allow read: if signedIn();

      allow create: if isAdmin() || (isSales()
        && request.resource.data.createdByUserId == request.auth.uid
      );

      allow update: if isAdmin() || (isSales()
        && resource.data.createdByUserId == request.auth.uid
        && resource.data.isLocked == false
      ) || (isWarehouse()
        && request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['deliveredTotals','status','isLocked','updatedAt'])
      );

      allow delete: if isAdmin();
    }

    // deliveries: warehouse/admin create+update
    match /deliveries/{id} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || isWarehouse();
      allow delete: if isAdmin();
    }

    // audit_logs: admin read. create allowed for signed in (free plan)
    match /audit_logs/{id} {
      allow read: if isAdmin();
      allow create: if signedIn();
      allow update, delete: if isAdmin();
    }
  }
}
